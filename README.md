# task_for_the_candidate
Расчёт изменения доли эмитентов в индексе Мосбиржи, которые торговались выше 50-дневной скользящей средней

# Подготовка к работе:
1. Создаем виртуальное окружение при помощи терминала
python -m venv venv
2. Заходим в него
./venv/Scripts/activate
3. Подгружаем библиотеки:
pip install -r requirements.txt
4. Необходимо получить собственный токен для подключения к API Тинькофф-Инвестиции, так как я свой токен убрал. Токен необходимо поместить в начале модуля processing.py в глобальную переменную (TOKEN).
5. Необходимо получить токен для бота, и создать канал для проверки работоспособности. Токен для бота необходимо поместить в файл «.env» в переменную BOT_TOKEN. В начале модуля main.py необходимо указать тэг канала в Telegram.

# Предпосылки:
1.	Все котировки собираются в единый датафрейм и с его помощью обрабатываются.
2.	Для расчёта целевого показателя бралась доля эмитентов, которые включались в базу расчёта, которая изменяется несколько раз за год.
3.	Я убрал свой API-токен для Тинькофф-Инвестиции, но оставил токен для бота и тэг группы (@teatingforbor).
4.	Логотип для водяного знака, лист с ребалансировками базы расчёта индекса Мосбиржи и инфографика хранятся в одной директории c модулями.
5. Модуль processing.py может работать самостоятельно без main.py. 
6. Версия Python: 3.10.7.
7. Цены для расчёта брали на момент окончания торгового дня (Close).

# Структура скрипта:
1.	config_reader.py – в нем лежат токен для подключения через API к Telegram-боту.
2.	processing.py – в данном файле содержится скрипт, который производит импорт данных через API, обработку данных и построение графика с его сохранением в текущей директории.
3.	main.py – основной файл-исполнитель, через который запускается бот, который будет отсылать инфографику в канал.

# Описание processing.py:
Функции:
1.	utcnow() – функция, возвращающая текущее время в формате UTC+0.
2.	create_df(*args) – функция, которая переводит результат запроса через API в датафрейм, с которым легко работать.
3.	cast_money(*args) – функция, возвращающая данные о цене в форму, удобную для обработки.
4.	sma_normal(*args) – функция, возвращающая скользящее среднее для стоимости ценной бумаги определённого эмитента, который торговался на протяжении года беспрерывно.
5.	sma_problem(*args) – функция, возвращающая скользящее среднее для стоимости ценной бумаги определённого эмитента, которая торговалась с перерывами или вообще перестала котироваться (сплит, обратный сплит, исключение из котировальных списков и прочее).
6.	parse_wb(*args) – функция, возвращающая два объекта: список эмитентов, которые входили в состав индекса Мосбиржи за последний год, и список кортежей: первый элемент кортежа – датафрейм (из одного столбца) с составом индекса в определенный промежуток времени, второй элемент – словарь с началом и концом этого промежутка.
7.	import_candles(*args) – функция, возвращающая котировки ценных бумаг. Через класс Client при помощи т.н. службы (из документации) instruments и метода share_by находим идентификатор figi по тикеру инструмента. Далее по figi Через класс Client при помощи т.н. службы (из документации) market_data и метода get_candles импортируем котировки ценной бумаги, которую потом оборачиваем в датафрейм, далее в ходе цикла объединяем все котировки в единый датафрейм, который является выходом функции. Данные импортируются более чем за год, чтобы скользящее среднее корректно рассчиталось.
8.	make_pic() – функция, в которой происходят импорт котировок через API, вычисления и вывод графика, в которой используются вышеуказанные функции. Итог работы – сохранение графика с динамикой доли эмитентов в индексе Мосбиржи, торгующихся выше 50-дневной скользящей средней и динамикой самого индекса Мосбиржи с добавлением водяного знака и логотипа.

На сайте Московской биржи лежат данные о ребалансировке базы расчёта индекса, которая изменяется каждую третью пятницу марта, июня, сентября и декабря, то есть в конце каждого квартала. Необходимо загрузить информацию о ребалансировках с сайта Мосбиржи перед началом работы.

# Рассмотрим подробнее make_pic():
1.	Определяем список эмитентов (unique_code_list), чьи ЦБ были в индексе Мосбиржи за последний год и список кортежей (new_list_imoex).
2.	Создаем пустой датафрейм (df_quotes).
3.	При помощи цикла заполняем df_quotes котировками ЦБ эмитентов из unique_code_list.
4.	Запрашиваем через API котировки индекса Мосбиржи.
5.	Определяем эмитентов, которые торговались всегда на протяжении года (normal_columns) и тех, чьи ЦБ торговались с перерывами (problem_columns).
6.	Рассчитываем скользящее среднее для эмитентов двух видов, описанных в предыдущем пункте.
7.	При помощи цикла проходимся по каждому периоду времени, в каждом из которых была своя база расчёта индекса Мосбиржи, рассчитываем долю тех эмитентов, которые торговались выше 50-дневной скользящей средней, после чего столбцы с днями торговых сессий и целевым показателем помещаем в итоговый датафрейм (df_result).
8.	Актуализируем итоговый датафрейм.
9.	Создаем и выгружаем график в текущую директорию, где лежит скрипт.

# Описание main.py:

Необходимо создать своего бота через BotFather в Telegram, дать ему имя и получить токен доступа.
Также необходимо создать канал в Telegram, добавить бота в канал, как администратора.

1.	Получаем инфографику через функцию make_pic() из модуля processing.py.
2.	Создаём асинхронную функцию send_gragh(), которая инициализирует бота, передав ему токен. После чего при помощи метода send_media_group, передав ей идентификатор группы и наш график. Отсылаем инфографику в канал.
3.	Создаём асинхронную функцию main(), которая запускает send_gragh().
4.	Происходит проверка, чтобы скрипт запускался из модуля main.py.
5.	При помощи AsyncIOScheduler задаём интервалы работы скрипта (каждый день недели в 12 часов утра по системному времени).
6.	Запускаем поток событий.

# P.S.
Осилить Docker и подключение PostgreSQL для бота у меня не получилось, я и так затянул с заданием, выполнение этих пунктов могло затратить ещё больше времени при учёте того, что у меня нет в этом опыта (надеюсь я ещё научусь этому), а так я старался выполнить все факультативные пункты в задании.
